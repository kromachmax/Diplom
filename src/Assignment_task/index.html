<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Визуализация назначений роботов на задачи</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden; /* Убираем скролл */
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        #controls {
            padding: 10px;
            background-color: #f0f0f0;
            text-align: center;
            flex-shrink: 0; /* Фиксированная высота */
        }
        button {
            padding: 8px 16px;
            margin: 5px;
            font-size: 14px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:hover {
            background-color: #45a049;
        }
        #status {
            font-size: 14px;
            color: #333;
            margin: 5px 0;
        }
        #canvas-container {
            flex-grow: 1; /* Занимает всё доступное пространство */
            position: relative;
            overflow: hidden;
        }
        #auctionCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="controls">
        <button onclick="prevIteration()">Предыдущая</button>
        <button onclick="nextIteration()">Следующая</button>
        <button onclick="toggleAutoPlay()">Воспроизвести</button>
        <span>Итерация: <span id="iterDisplay">1</span></span>
        <div id="status">Загрузка данных...</div>
    </div>
    <div id="canvas-container">
        <div id="auctionCanvas"></div>
    </div>
    <script>
        let iterations = [];
        let currentIter = 0;
        let autoPlay = false;
        let lastSwitchTime = Date.now();
        const AUTO_PLAY_INTERVAL = 2000; // 2 секунды
        let animProgress = 0;
        const ANIM_DURATION = 30; // 0.5 секунды при 60 FPS

        // Загрузка JSON
        fetch('auction_assignments.json')
            .then(response => {
                if (!response.ok) throw new Error('Не удалось загрузить auction_assignments.json');
                return response.json();
            })
            .then(data => {
                iterations = data;
                document.getElementById('status').textContent = `Загружено ${iterations.length} итераций`;
                console.log('JSON загружен:', iterations.length, 'итераций');
                updateIterDisplay();
            })
            .catch(error => {
                document.getElementById('status').textContent = 'Ошибка загрузки данных';
                console.error('Ошибка:', error);
            });

        // p5.js sketch для аукционного алгоритма
        let sketch = function(p) {
            p.setup = function() {
                const canvas = p.createCanvas(p.windowWidth, p.windowHeight - document.getElementById('controls').offsetHeight);
                canvas.parent('canvas-container');
                p.textAlign(p.CENTER, p.CENTER);
                p.textSize(12);
                p.frameRate(60);
            };

            p.windowResized = function() {
                p.resizeCanvas(p.windowWidth, p.windowHeight - document.getElementById('controls').offsetHeight);
            };

            p.draw = function() {
                p.background(255);
                if (iterations.length === 0) {
                    p.fill(0);
                    p.text('Ожидание данных...', p.width / 2, p.height / 2);
                    return;
                }

                const data = iterations[currentIter];
                const { n, m, assignment, robot_coords, task_coords } = data;

                // Масштабирование координат с учетом новых размеров
                const margin = Math.min(p.width, p.height) * 0.05;
                const scaleX = (p.width - 2 * margin) / 100;
                const scaleY = (p.height - 2 * margin) / 100;

                // Рисуем роботов (синие круги)
                for (let i = 0; i < n; i++) {
                    let x = margin + robot_coords[i][0] * scaleX;
                    let y = margin + robot_coords[i][1] * scaleY;
                    p.fill(100, 100, 255);
                    p.noStroke();
                    p.ellipse(x, y, 15, 15);
                    p.fill(0);
                    p.text(`R${i}`, x, y + 25);
                }

                // Рисуем задачи (красные квадраты)
                for (let j = 0; j < m; j++) {
                    let x = margin + task_coords[j][0] * scaleX;
                    let y = margin + task_coords[j][1] * scaleY;
                    p.fill(255, 100, 100);
                    p.noStroke();
                    p.rect(x - 10, y - 10, 20, 20);
                    p.fill(0);
                    p.text(`T${j}`, x, y + 25);
                }

                // Рисуем назначения (зелёные линии)
                p.stroke(0, 150, 0);
                p.strokeWeight(2);
                for (let i = 0; i < n; i++) {
                    if (assignment[i] >= 0 && assignment[i] < m) {
                        let startX = margin + robot_coords[i][0] * scaleX;
                        let startY = margin + robot_coords[i][1] * scaleY;
                        let endX = margin + task_coords[assignment[i]][0] * scaleX;
                        let endY = margin + task_coords[assignment[i]][1] * scaleY;
                        let t = Math.min(animProgress / ANIM_DURATION, 1);
                        let interpX = startX + (endX - startX) * t;
                        let interpY = startY + (endY - startY) * t;
                        p.line(startX, startY, interpX, interpY);
                    }
                }
                p.noStroke();
            };
        };

        // Создание p5.js экземпляра
        new p5(sketch, 'auctionCanvas');

        // Управление итерациями
        function nextIteration() {
            if (currentIter < iterations.length - 1) {
                currentIter++;
                animProgress = 0;
                updateIterDisplay();
                lastSwitchTime = Date.now();
                console.log('Итерация:', currentIter + 1);
            } else {
                autoPlay = false;
                document.querySelector('button[onclick="toggleAutoPlay()"]').textContent = "Воспроизвести";
                console.log('Последняя итерация');
            }
        }

        function prevIteration() {
            if (currentIter > 0) {
                currentIter--;
                animProgress = 0;
                updateIterDisplay();
                lastSwitchTime = Date.now();
                console.log('Итерация:', currentIter + 1);
            }
        }

        function toggleAutoPlay() {
            autoPlay = !autoPlay;
            lastSwitchTime = Date.now();
            document.querySelector('button[onclick="toggleAutoPlay()"]').textContent = autoPlay ? "Пауза" : "Воспроизвести";
            console.log('Автопроигрывание:', autoPlay ? 'включено' : 'выключено');
        }

        function updateIterDisplay() {
            document.getElementById('iterDisplay').textContent = currentIter + 1;
        }

        // Обновление анимации
        setInterval(() => {
            if (animProgress < ANIM_DURATION) {
                animProgress++;
            }
            if (autoPlay && Date.now() - lastSwitchTime > AUTO_PLAY_INTERVAL) {
                nextIteration();
            }
        }, 1000 / 60);
    </script>
</body>
</html>
